<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendientes de Atención</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --anydo-blue: #0085ff; --bg: #ffffff; --text: #2c2c2c; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .header { margin-bottom: 20px; padding-top: 10px; }
        h1 { font-size: 32px; font-weight: 700; margin: 0; letter-spacing: -1px; }
        
        /* Selector de Base Estilo Minimalista */
        .filter-container {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-container select {
            border: none; background: transparent; font-size: 16px; 
            font-weight: 600; color: var(--anydo-blue); outline: none; flex-grow: 1;
        }

        .task-list { margin-top: 20px; }
        
        .task-card {
            display: flex; align-items: center;
            padding: 18px; margin-bottom: 12px;
            border-radius: 16px; border: 1px solid #f0f0f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .circle { 
            width: 24px; height: 24px; border: 2px solid #d1d1d1; 
            border-radius: 50%; margin-right: 15px; flex-shrink: 0;
        }

        .task-info { flex-grow: 1; }
        .task-title { font-size: 17px; font-weight: 600; display: block; }
        .task-sub { font-size: 13px; color: #909090; }
        .base-badge { font-size: 10px; background: #e0f0ff; color: var(--anydo-blue); padding: 2px 8px; border-radius: 6px; margin-left: 5px; }

        /* Modal y campos igual que el anterior... */
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 100; padding: 40px 20px; box-sizing: border-box; }
        .field { margin-bottom: 25px; }
        .label { font-size: 12px; font-weight: 700; color: var(--anydo-blue); text-transform: uppercase; }
        input, textarea { width: 100%; border: none; border-bottom: 2px solid #f0f0f0; padding: 10px 0; font-size: 18px; outline: none; }
        .btn-close { background: var(--anydo-blue); color: white; border: none; padding: 20px; width: 100%; border-radius: 14px; font-size: 18px; font-weight: 700; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Tareas Pendientes</h1>
        <div class="filter-container">
            <i class="fa-solid fa-location-dot" style="color: #adb5bd;"></i>
            <select id="filtroBase" onchange="renderizarLista()">
                <option value="TODAS">Todas las bases</option>
                <option value="ATLA">Atlacomulco</option>
                <option value="COLI">Colima</option>
                <option value="GUZM">Ciudad Guzmán</option>
                <option value="GDLJ">Guadalajara</option>
                <option value="JILO">Jilotepec</option>
                <option value="MORE">Morelia</option>
                <option value="OFOC">Occidente</option>
                <option value="TSAT">Saturno</option>
                <option value="TOLU">Toluca</option>
            </select>
        </div>
    </div>

    <div class="task-list" id="lista">
        </div>

    <div id="modal">
        <div onclick="cerrarModal()"><i class="fa-solid fa-xmark" style="font-size: 24px; color: #ccc;"></i></div>
        <h2 id="modalUnidad" style="font-size: 28px; margin-top:20px;">Unidad</h2>
        <p id="modalFalla" style="color: #909090; margin-bottom: 40px;"></p>
        <div class="field"><span class="label">Clave de Colaborador</span><input type="number" id="tecNomina"></div>
        <div class="field"><span class="label">Qué se le hizo al equipo</span><textarea id="tecComentarios"></textarea></div>
        <button class="btn-close" onclick="guardarAtencion()">Finalizar Tarea</button>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzZ5tTF-Rb4wD1XT7_HRnl0S-8-Mv8J9pSXBzz4wx9RHQVTGdJFTs-exOg_3efivwPo/exec";
        let reportesCache = []; // Para filtrar sin volver a consultar la DB

        async function cargarDatos() {
            const lista = document.getElementById('lista');
            lista.innerHTML = "<p style='text-align:center; color:#999;'>Sincronizando con la nube...</p>";
            try {
                const res = await fetch(scriptURL);
                reportesCache = await res.json();
                renderizarLista();
            } catch (e) { lista.innerHTML = "Error al cargar datos."; }
        }

        function renderizarLista() {
            const lista = document.getElementById('lista');
            const baseSeleccionada = document.getElementById('filtroBase').value;
            lista.innerHTML = "";

            // FILTRO DOBLE: Que sea de la base Y que el estatus sea "ABIERTO"
            const filtrados = reportesCache.filter(item => {
                const coincideBase = (baseSeleccionada === "TODAS" || item.base === baseSeleccionada);
                const estaAbierto = (item.estatus === "ABIERTO");

                return coincideBase && estaAbierto;
            });

            if(filtrados.length === 0) {
                lista.innerHTML = "<p style='text-align:center; padding:40px; color:#ccc;'>No hay pendientes en esta base ✨</p>";
                return;
            }

            filtrados.forEach(item => {
                lista.innerHTML += `
                    <div class="task-card" onclick="abrirAtencion('${item.id}', '${item.eco}', '${item.falla}')">
                        <div class="circle"></div>
                        <div class="task-info">
                            <span class="task-title">Unidad ${item.eco} <span class="base-badge">${item.base}</span></span>
                            <span class="task-sub">${item.falla}</span>
                        </div>
                    </div>
                `;
            });
        }

        function abrirAtencion(id, eco, falla) {
            window.idSeleccionado = id;
            document.getElementById('modalUnidad').innerText = "Unidad " + eco;
            document.getElementById('modalFalla').innerText = falla;
            document.getElementById('modal').style.display = "block";
        }

        function cerrarModal() { document.getElementById('modal').style.display = "none"; }

        async function guardarAtencion() {
            const btn = document.querySelector('.btn-close');
            const datos = {
                accion: "ATENDER",
                id: window.idSeleccionado,
                tecnico: document.getElementById('tecNomina').value,
                comentarios: document.getElementById('tecComentarios').value
            };

            if(!datos.tecnico) return alert("Ingresa tu clave de colaborador");
            btn.disabled = true; btn.innerText = "Guardando...";

            await fetch(scriptURL, { method: "POST", mode: "no-cors", body: JSON.stringify(datos) });
            
            cerrarModal();
            cargarDatos(); // Recargar todo
        }

        cargarDatos();
    </script>
</body>
</html>
