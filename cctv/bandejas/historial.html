<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rastreo de Eventos y Bandejas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --finder-sidebar: #efeff0;
            --finder-border: #d2d2d2;
            --ios-blue: #007aff;
            --ios-bg: #f2f2f7;
            --ios-green: #34c759;
            --ios-red: #ff3b30;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background-color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- LAYOUT MAC: FINDER --- */
        .mac-container { display: flex; height: 100vh; width: 100%; }
        
        .sidebar {
            width: 210px; background: var(--finder-sidebar); border-right: 1px solid var(--finder-border);
            padding: 10px; display: flex; flex-direction: column; gap: 5px;
        }
        .traffic-lights { display: flex; gap: 8px; padding: 10px 0 20px 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }

        .sidebar-item {
            padding: 7px 10px; border-radius: 6px; font-size: 13px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; color: #444;
        }
        .sidebar-item.active { background: #cecece; font-weight: 500; }

        .finder-content { flex: 1; display: flex; flex-direction: column; position: relative; background: #fff; }
        
        /* TOOLBAR (SEARCH ARRIBA EN MAC) */
        .toolbar {
            height: 52px; border-bottom: 1px solid var(--finder-border);
            display: flex; align-items: center; padding: 0 15px; background: #fff;
            justify-content: space-between;
        }

        .search-box {
            background: #f1f1f1; border: 1px solid #ccc; border-radius: 8px;
            padding: 5px 10px; display: flex; align-items: center; gap: 8px; width: 280px;
        }
        .search-box input { border: none; background: transparent; outline: none; font-size: 13px; width: 100%; }

        /* --- RESULTADOS & TIMELINE --- */
        .results-view { flex: 1; overflow-y: auto; padding: 25px; background: var(--ios-bg); }

        .timeline-card {
            background: #fff; border-radius: 14px; padding: 20px; margin-bottom: 18px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 0.5px solid #d1d1d6;
            max-width: 650px; margin-left: auto; margin-right: auto;
        }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 18px; }
        .bus-id { font-size: 19px; font-weight: 800; color: #000; letter-spacing: -0.5px; }
        .status-tag { font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 6px; }

        /* Estilo Escalera (Timeline) */
        .staircase { margin-left: 12px; border-left: 2px solid #e5e5ea; padding-left: 24px; position: relative; }
        .node { position: relative; margin-bottom: 25px; }
        .node:last-child { margin-bottom: 0; }
        .node::before {
            content: ''; position: absolute; left: -31px; top: 4px;
            width: 12px; height: 12px; border-radius: 50%; background: #c6c6c8; border: 3px solid #fff;
            box-shadow: 0 0 0 1px #e5e5ea;
        }
        .node.up::before { background: var(--ios-green); }
        .node.down::before { background: var(--ios-red); }
        .node.active-node::before { background: var(--ios-blue); }
        
        .node-label { font-size: 10px; font-weight: 700; color: #8e8e93; text-transform: uppercase; }
        .node-val { font-size: 16px; font-weight: 600; display: block; color: #000; margin-top: 2px; }
        .node-meta { font-size: 13px; color: #8e8e93; margin-top: 2px; }

        .duration-footer {
            margin-top: 18px; padding-top: 12px; border-top: 0.5px solid #f2f2f7;
            font-size: 13px; font-weight: 700; color: var(--ios-blue); display: flex; align-items: center; gap: 8px;
        }

        /* --- RESPONSIVE: IPHONE (SEARCH ABAJO) --- */
        @media (max-width: 850px) {
            .sidebar { display: none; }
            .toolbar { height: 60px; justify-content: center; } /* Solo título arriba */
            .toolbar .search-box { display: none; } /* Ocultar buscador de arriba */

            /* Buscador Flotante Inferior */
            .mobile-search-bar {
                display: flex !important;
                position: fixed; bottom: 30px; left: 16px; right: 16px;
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                border: 0.5px solid rgba(0,0,0,0.1);
                box-shadow: 0 8px 32px rgba(0,0,0,0.12);
                border-radius: 18px; padding: 12px 20px; z-index: 1000;
                align-items: center; gap: 12px;
            }
            .mobile-search-bar input { border: none; background: transparent; outline: none; font-size: 17px; width: 100%; }
            .mobile-search-bar i { color: var(--ios-blue); font-size: 20px; }

            .results-view { padding: 16px; padding-bottom: 120px; }
            .timeline-card { max-width: 100%; }
        }

        .mobile-search-bar { display: none; }
    </style>
</head>
<body>

    <div class="mac-container">
        <aside class="sidebar">
            <div class="traffic-lights">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
            </div>
            <p style="font-size: 11px; font-weight: 700; color: #8e8e93; margin: 10px 0 5px 10px;">TRAZABILIDAD</p>
            <div id="segBus" class="sidebar-item active" onclick="cambiarModo('bus')">
                <i class="fa-solid fa-bus"></i> Por Autobús
            </div>
            <div id="segDisco" class="sidebar-item" onclick="cambiarModo('disco')">
                <i class="fa-solid fa-hard-drive"></i> Por Bandeja
            </div>
            <div id="status-text" style="font-size: 10px; color: #999; margin-top: auto; text-align: center; padding: 10px;">Sincronizando...</div>
        </aside>

        <div class="finder-content">
            <header class="toolbar">
                <div style="font-size: 14px; font-weight: 700; color: #333;">Rastreo de Eventos y Bandejas</div>
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass" style="color:#aaa"></i>
                    <input type="text" id="userInput" placeholder="Buscar..." oninput="syncAndProcess(this.value)">
                </div>
                <div style="width: 20px;"></div>
            </header>

            <main class="results-view" id="resultados">
                <div style="text-align: center; margin-top: 100px; color: #8e8e93;">
                    <i class="fa-solid fa-timeline" style="font-size: 45px; margin-bottom: 15px; opacity: 0.2;"></i>
                    <p>Ingresa un número de Autobús para comenzar el rastreo</p>
                </div>
            </main>

            <div class="mobile-search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="userInputMobile" placeholder="Buscar unidad o bandeja..." oninput="syncAndProcess(this.value)">
            </div>
        </div>
    </div>

<script>
    // --- LÓGICA CORE (CEREBRO PRINCIPAL) ---
    const scriptURL = "https://script.google.com/macros/s/AKfycbzSSGiu0bZIJgHheutgfD0MiqFNGkB0jxga_hNJu8T5R4ZLe-_FdjxvUR2uGXl_e-YG/exec"; 
    let database = [];
    let modoActual = 'bus';

    async function cargar() {
        const st = document.getElementById('status-text');
        try {
            st.innerText = "⏳ Sincronizando...";
            const res = await fetch(`${scriptURL}?accion=leerHistorial`);
            const data = await res.json();
            database = data.sort((a, b) => new Date(a[0]).getTime() - new Date(b[0]).getTime());
            st.innerText = "✅ Finder Activo";
        } catch (e) { st.innerText = "❌ Error Red"; }
    }

    // Sincroniza ambos inputs (Mac/iPhone) para que funcionen igual
    function syncAndProcess(val) {
        document.getElementById('userInput').value = val;
        document.getElementById('userInputMobile').value = val;
        procesar();
    }

    function cambiarModo(m) {
        modoActual = m;
        document.getElementById('segBus').classList.toggle('active', m === 'bus');
        document.getElementById('segDisco').classList.toggle('active', m === 'disco');
        syncAndProcess("");
        document.getElementById('resultados').innerHTML = "";
    }

    function procesar() {
        const container = document.getElementById('resultados');
        const query = document.getElementById('userInput').value.trim().toUpperCase();
        if (!query) {
            container.innerHTML = `<div style="text-align: center; margin-top: 100px; color: #8e8e93;"><i class="fa-solid fa-timeline" style="font-size: 45px; margin-bottom: 15px; opacity: 0.2;"></i><p>Ingresa un ID para comenzar el rastreo</p></div>`;
            return;
        }
        container.innerHTML = "";

        let subset = modoActual === 'bus' 
            ? database.filter(r => r[3] && r[3].toString() === query)
            : database.filter(r => (r[4] && r[4].toString().toUpperCase() === query) || (r[5] && r[5].toString().toUpperCase() === query));

        const subidas = subset.filter(r => {
            if (modoActual === 'bus') return r[4]; 
            return r[4] && r[4].toString().toUpperCase() === query; 
        });

        subidas.forEach(rSube => {
            const tSube = new Date(rSube[0]).getTime();
            const idBandejaSube = rSube[4];
            const idBusSube = rSube[3];

            const rBaja = database.find(r => 
                r[5] && r[5].toString().toUpperCase() === (modoActual === 'bus' ? idBandejaSube.toUpperCase() : query) &&
                new Date(r[0]).getTime() > tSube
            );

            const proximaSubida = database.find(r => {
                const tRef = new Date(r[0]).getTime();
                if (modoActual === 'bus') {
                    return r[3] && r[3].toString() === query && r[4] && tRef > tSube;
                } else {
                    return r[4] && r[4].toString().toUpperCase() === query && tRef > tSube;
                }
            });

            let status = "activo";
            if (rBaja) {
                if (proximaSubida && new Date(rBaja[0]).getTime() > new Date(proximaSubida[0]).getTime()) {
                    status = "inconsistente";
                } else {
                    status = "finalizado";
                }
            } else if (proximaSubida) {
                status = "inconsistente";
            }

            const titulo = modoActual === 'bus' ? idBandejaSube : `Unidad ${idBusSube}`;
            container.insertAdjacentHTML('afterbegin', renderCard(titulo, rSube, (status === "finalizado" ? rBaja : null), status));
        });
    }

    function renderCard(titulo, sube, baja, status) {
        let config = { color: "#34c759", label: "EN OPERACIÓN", icon: "fa-circle-play" };
        let duracionStr = "En Tránsito";

        if (status === "finalizado") {
            config = { color: "#8e8e93", label: "CICLO TERMINADO", icon: "fa-circle-check" };
            const diff = Math.abs(new Date(baja[0]) - new Date(sube[0]));
            duracionStr = `${Math.floor(diff/864e5)}d ${Math.floor((diff%864e5)/36e5)}h en DVR`;
        } else if (status === "inconsistente") {
            config = { color: "#ff9500", label: "SIN CIERRE", icon: "fa-triangle-exclamation" };
            duracionStr = "⚠️ Error de registro";
        }

        const f1 = new Date(sube[0]).toLocaleString('es-MX', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
        const f2 = baja ? new Date(baja[0]).toLocaleString('es-MX', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : (status === "inconsistente" ? "Desconocida" : "Operando");

        return `
            <div class="timeline-card">
                <div class="card-header">
                    <span class="bus-id">${titulo}</span>
                    <span class="status-tag" style="background:${config.color}15; color:${config.color}">
                        <i class="fa-solid ${config.icon}"></i> ${config.label}
                    </span>
                </div>
                <div class="staircase">
                    <div class="node up">
                        <span class="node-label">INSTALACIÓN (SUBIDA)</span>
                        <span class="node-val">${f1}</span>
                        <span class="node-meta">${sube[2]} • ${sube[1]}</span>
                    </div>
                    <div class="node ${status === 'finalizado' ? 'down' : 'active-node'}">
                        <span class="node-label">${status === 'finalizado' ? 'RETIRO (BAJADA)' : 'ESTADO ACTUAL'}</span>
                        <span class="node-val">${f2}</span>
                        <span class="node-meta">${baja ? (baja[2] + ' • ' + baja[1]) : 'Bandeja activa en la unidad'}</span>
                    </div>
                </div>
                <div class="duration-footer">
                    <i class="fa-solid fa-hourglass-half"></i> Permanencia: ${duracionStr}
                </div>
            </div>
        `;
    }

    window.onload = cargar;
</script>
</body>
</html>
