<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movimientos CCTV - Live Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --finder-top: linear-gradient(to bottom, #4d4d4d, #2d2d2d);
            --mac-bg: #ececec;
            --ios-blue: #007aff;
            --ios-bg: #f2f2f7;
            --glass: rgba(255, 255, 255, 0.9);
            --border: #c6c6c8;
            --success: #34c759;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--mac-bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADERS --- */
        .mac-header {
            background: var(--finder-top); height: 45px; display: flex; align-items: center;
            padding: 0 15px; border-bottom: 1px solid #1a1a1a; z-index: 1000; color: #fff;
        }
        .mobile-status-bar {
            display: none; position: sticky; top: 0; background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 12px 16px; border-bottom: 0.5px solid var(--border); z-index: 1500;
            justify-content: space-between; align-items: center;
        }

        .traffic-lights { display: flex; gap: 8px; margin-right: 20px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }
        
        .live-indicator {
            margin-left: auto; font-size: 11px; display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 12px;
        }
        .pulse, .pulse-mini { background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        .pulse { width: 8px; height: 8px; }
        .pulse-mini { width: 6px; height: 6px; display: inline-block; }

        /* --- LAYOUT & SIDEBAR --- */
        .wrapper { flex: 1; display: flex; overflow: hidden; }
        .sidebar { 
            width: 250px; background: rgba(235, 235, 235, 0.8); backdrop-filter: blur(20px);
            border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0;
        }
        .side-group-title { font-size: 11px; font-weight: 700; color: #8e8e93; padding: 10px 20px; text-transform: uppercase; }
        .side-item { padding: 10px 20px; display: flex; align-items: center; gap: 12px; color: #333; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .side-item.active { background: var(--ios-blue); color: white; border-radius: 0 20px 20px 0; margin-right: 10px; }

        #periodo-desktop {
            width: calc(100% - 40px); margin: 0 20px; padding: 8px; border-radius: 8px;
            border: 1px solid var(--border); background-color: #fff; font-size: 13px; cursor: pointer;
        }

        .main-content { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }

        /* --- VIEWS --- */
        .desktop-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .desktop-table th { position: sticky; top: 0; background: #f5f5f7; padding: 12px; text-align: left; border-bottom: 1px solid var(--border); color: #666; }
        .desktop-table td { padding: 12px; border-bottom: 0.5px solid #eee; }

        .mobile-list { display: none; flex-direction: column; gap: 12px; }
        .card { background: #fff; border-radius: 12px; padding: 15px; border: 0.5px solid var(--border); }
        .card-eco { font-size: 18px; font-weight: 700; color: var(--ios-blue); }
        .tray-box { background: #f2f2f7; padding: 8px; border-radius: 6px; flex: 1; }

        /* --- NAVIGATION & MODAL --- */
        .bottom-nav { 
            display: none; position: fixed; bottom: 0; width: 100%; height: 80px; 
            background: #fff; border-top: 0.5px solid var(--border); justify-content: space-around; 
            align-items: center; padding-bottom: 20px; z-index: 2000;
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #8e8e93; font-size: 10px; gap: 5px; background: none; border: none; }
        .nav-btn.active { color: var(--ios-blue); }
        .nav-btn i { font-size: 22px; }

        #mobile-filter-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 3000; display: none;
            justify-content: flex-end; flex-direction: column;
        }
        .filter-sheet {
            background: var(--ios-bg); border-radius: 20px 20px 0 0;
            padding: 25px 20px 40px; animation: slideUp 0.3s ease-out;
        }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); font-size: 16px; background: white; }
        .btn-apply { background: var(--ios-blue); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-size: 17px; font-weight: 600; margin-top: 10px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 850px) {
            .sidebar, .mac-header, .desktop-table { display: none; }
            .mobile-status-bar { display: flex; }
            .mobile-list { display: flex; padding-bottom: 100px; }
            .bottom-nav { display: flex; }
            .main-content { background: transparent; padding: 10px 15px; }
            body { background: var(--ios-bg); }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header class="mac-header">
        <div class="traffic-lights">
            <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
        </div>
        <span>Historial de Movimientos</span>
        <div class="live-indicator">
            <div class="pulse"></div>
            <span class="refresh-status-label">Sincronizado</span>
        </div>
    </header>

    <header class="mobile-status-bar">
        <div style="display: flex; flex-direction: column;">
            <h1 style="font-size: 17px; font-weight: 700;">Historial de Movimientos</h1>
            <div style="font-size: 11px; color: #8e8e93; display: flex; align-items: center; gap: 4px;">
                <span class="pulse-mini"></span>
                <span class="refresh-status-label">Cargando...</span>
            </div>
        </div>
        <div style="color: var(--ios-blue); font-size: 12px; font-weight: 600;" id="mobile-base-indicator">TODAS</div>
    </header>

    <div class="wrapper">
        <aside class="sidebar">
            <p class="side-group-title">Base Operativa</p>
            <nav id="base-filters">
                <a href="javascript:void(0)" class="side-item active" onclick="updateFilters('TODAS', null, this)">Todas</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('ACAP', null, this)">Acapulco</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('ATLA', null, this)">Atlacomulco</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('COLI', null, this)">Colima</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('GDLJ', null, this)">Guadalajara</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('GUZM', null, this)">Ciudad Guzmán</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('JILO', null, this)">Jilotepec</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('MORE', null, this)">Morelia</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('OFOC', null, this)">Occidente</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('JRIO', null, this)">San Juan del Río</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('TSAT', null, this)">Saturno</a>
                <a href="javascript:void(0)" class="side-item" onclick="updateFilters('TOLU', null, this)">Toluca</a>
            </nav>
            <p class="side-group-title">Periodo de Tiempo</p>
            <select id="periodo-desktop" onchange="updateFilters(null, this.value)">
                <option value="HOY" selected>Hoy</option>
                <option value="AYER">Ayer</option>
                <option value="SEMANA">Esta Semana</option>
                <option value="MES">Este mes</option>
            </select>
        </aside>

        <main class="main-content">
            <table class="desktop-table">
                <thead>
                    <tr><th>Fecha</th><th>Eco</th><th>Base</th><th>Sube</th><th>Baja</th><th>Técnico</th></tr>
                </thead>
                <tbody id="data-body-desktop"></tbody>
            </table>
            <div class="mobile-list" id="data-body-mobile"></div>
        </main>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="loadData()"><i class="fa-solid fa-house"></i><span>Inicio</span></button>
        <button class="nav-btn" onclick="toggleFilterModal()"><i class="fa-solid fa-sliders"></i><span>Filtros</span></button>
        <button class="nav-btn" onclick="window.location.reload()"><i class="fa-solid fa-rotate"></i><span>Refrescar</span></button>
    </nav>

    <div id="mobile-filter-modal" onclick="if(event.target==this) toggleFilterModal()">
        <div class="filter-sheet" onclick="event.stopPropagation()">
            <h2 style="text-align:center; margin-bottom:20px;">Filtros</h2>
            <div style="margin-bottom:20px;">
                <span style="font-size:12px; color:#8e8e93; text-transform:uppercase;">Base</span>
                <select id="mobile-base">
                    <option value="TODAS">Todas las Bases</option>
                    <option value="ACAP">Acapulco</option>
                    <option value="ATLA">Atlacomulco</option>
                    <option value="COLI">Colima</option>
                    <option value="GDLJ">Guadalajara</option>
                    <option value="GUZM">Ciudad Guzmán</option>
                    <option value="JILO">Jilotepec</option>
                    <option value="MORE">Morelia</option>
                    <option value="OFOC">Occidente</option>
                    <option value="JRIO">San Juan del Río</option>
                    <option value="TSAT">Saturno</option>
                    <option value="TOLU">Toluca</option>
                </select>
            </div>
            <div style="margin-bottom:20px;">
                <span style="font-size:12px; color:#8e8e93; text-transform:uppercase;">Periodo</span>
                <select id="mobile-periodo">
                    <option value="HOY" selected>Hoy</option>
                    <option value="AYER">Ayer</option>
                    <option value="SEMANA">Esta Semana</option>
                    <option value="MES">Este Mes</option>
                </select>
            </div>
            <button class="btn-apply" onclick="applyMobileFilters()">Aplicar y Consultar</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzSSGiu0bZIJgHheutgfD0MiqFNGkB0jxga_hNJu8T5R4ZLe-_FdjxvUR2uGXl_e-YG/exec";
        let currentBase = "TODAS";
        let currentPeriodo = "SEMANA";

        function updateFilters(base, periodo, el) {
            if (base) currentBase = base;
            if (periodo) currentPeriodo = periodo;
            if (el) {
                document.querySelectorAll('.side-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            loadData();
        }

        function toggleFilterModal() {
            const modal = document.getElementById('mobile-filter-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function applyMobileFilters() {
            currentBase = document.getElementById('mobile-base').value;
            currentPeriodo = document.getElementById('mobile-periodo').value;
            toggleFilterModal();
            loadData();
        }

        async function loadData() {
            const statusLabels = document.querySelectorAll('.refresh-status-label');
            const mobileBaseIndicator = document.getElementById('mobile-base-indicator');

            statusLabels.forEach(el => el.innerText = "Actualizando...");
            if(mobileBaseIndicator) mobileBaseIndicator.innerText = currentBase;
            
            const url = `${API_URL}?accion=getMovimientos&base=${currentBase}&periodo=${currentPeriodo}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                renderData(data);
                const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                statusLabels.forEach(el => el.innerText = `Sincronizado: ${time}`);
            } catch (error) {
                statusLabels.forEach(el => el.innerText = "Error de red");
            }
        }

        function renderData(data) {
            const desktopBody = document.getElementById('data-body-desktop');
            const mobileBody = document.getElementById('data-body-mobile');
            desktopBody.innerHTML = ""; mobileBody.innerHTML = "";

            data.forEach(row => {
                const fecha = new Date(row[0]).toLocaleString('es-MX', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
                const [full, base, tech, eco, sube, baja] = row;

                desktopBody.innerHTML += `<tr><td>${fecha}</td><td><b>${eco}</b></td><td>${base}</td><td style="color:var(--success)">${sube}</td><td style="color:red">${baja}</td><td>${tech}</td></tr>`;

                mobileBody.innerHTML += `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span class="card-eco">Bus ${eco}</span>
                            <span style="font-size:12px; color:#8e8e93;">${fecha}</span>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <div class="tray-box"><small style="color:var(--success)">▲ SUBE</small><br><b>${sube}</b></div>
                            <div class="tray-box"><small style="color:red">▼ BAJA</small><br><b>${baja}</b></div>
                        </div>
                        <div style="margin-top:10px; font-size:11px; color:#8e8e93;">Técnico: ${tech} | Base: ${base}</div>
                    </div>`;
            });
        }

        setInterval(() => { if (!document.hidden) loadData(); }, 30000);
        window.onload = loadData;
    </script>
</body>
</html>
