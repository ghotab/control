<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uso de Boletos de Tijera por Falla</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <style>
        :root {
            --ios-bg: #f5f5f7;
            --ios-sidebar: rgba(232, 232, 237, 0.8);
            --ios-blue: #007aff;
            --ios-card: #ffffff;
            --ios-border: #d1d1d6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--ios-bg);
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }

        /* BARRA LATERAL */
        .sidebar {
            width: 280px; background: var(--ios-sidebar);
            backdrop-filter: blur(20px); border-right: 0.5px solid var(--ios-border);
            padding: 20px; display: flex; flex-direction: column;
        }

        .sidebar h2 { font-size: 13px; color: #8e8e93; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 0.5px; }

        /* PANEL PRINCIPAL */
        .main-content { flex: 1; overflow-y: auto; padding: 30px 40px; }
        .header-area { margin-bottom: 30px; }
        
        /* WIDGETS */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--ios-card); padding: 20px; border-radius: 12px; border: 0.5px solid var(--ios-border); }
        .stat-card span { font-size: 13px; color: #8e8e93; font-weight: 600; }
        .stat-card h3 { font-size: 28px; margin: 5px 0 0 0; color: var(--ios-blue); }

        /* TABLA MACOS */
        .data-table { width: 100%; border-collapse: collapse; background: var(--ios-card); border-radius: 12px; overflow: hidden; border: 0.5px solid var(--ios-border); }
        .data-table th { background: #fdfdfd; padding: 12px 15px; text-align: left; font-size: 12px; color: #8e8e93; border-bottom: 0.5px solid var(--ios-border); text-transform: uppercase; }
        .data-table td { padding: 15px; font-size: 14px; border-bottom: 0.5px solid var(--ios-border); color: #333; }
        .data-table tr:hover { background-color: #f9f9fb; }

        /* BADGES */
        .badge-tijera { background: #fff2f2; color: #ff3b30; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 11px; border: 0.5px solid #ff3b30; }
        
        /* FILTROS */
        .filter-group { margin-bottom: 20px; }
        .filter-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
        .filter-group select, .filter-group input { 
            width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--ios-border); 
            background: white; font-size: 14px; outline: none; box-sizing: border-box;
            font-family: inherit; color: var(--ios-blue);
        }

        /* Estilo iOS para el input de fecha nativo */
        input[type="date"] {
            position: relative;
            text-align: right;
        }

        /* Ajuste para que se vea como iOS/macOS */
        .flatpickr-calendar {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px);
            border-radius: 12px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
            border: 0.5px solid var(--ios-border) !important;
        }
        .flatpickr-day.selected {
            background: var(--ios-blue) !important;
            border-color: var(--ios-blue) !important;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>FILTROS DE ANÁLISIS</h2>
        
        <div class="filter-group">
            <label>Base Operativa</label>
            <select id="fBase" onchange="cargarAnalisis()">
                <option value="TODAS">Todas las Bases</option>
                <option value="ATLA">Atlacomulco</option>
                <option value="COLI">Colima</option>
                <option value="GDLJ">Guadalajara</option>
                <option value="GUZM">Ciudad Guzmán</option>
                <option value="JILO">Jilotepec</option>
                <option value="MORE">Morelia</option>
                <option value="OFOC">Occidente</option>
                <option value="TOLU">Toluca</option>
                <option value="TSAT">Saturno</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Desde</label>
            <input type="text" id="fInicio" placeholder="Seleccionar fecha...">
        </div>

        <div class="filter-group">
            <label>Hasta</label>
            <input type="text" id="fFin" placeholder="Seleccionar fecha...">
        </div>

        <div style="margin-top: auto; font-size: 12px; color: #8e8e93; line-height: 1.4;">
            <i class="fa-solid fa-circle-info"></i> Filtro activo: <br><b>Solo fallas con uso de Boletos de Tijera</b>.
        </div>
    </div>

    <div class="main-content">
        <div class="header-area">
            <h1 style="margin:0; font-size: 28px; letter-spacing: -0.5px;">Uso de Boletos de Tijera por Falla</h1>
            <p style="color: #8e8e93; margin: 5px 0 0 0;">Análisis Estadístico Boleteras</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><span>Total Incidencias</span><h3 id="statTotal">0</h3></div>
            <div class="stat-card"><span>Autobus Recurrente</span><h3 id="statEco">---</h3></div>
            <div class="stat-card"><span>Base Crítica</span><h3 id="statBase">---</h3></div>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Base</th>
                    <th>Autobús</th>
                    <th>Falla</th>
                    <th>Causa</th>
                    <th>Estatus</th>
                </tr>
            </thead>
            <tbody id="tablaCuerpo"></tbody>
        </table>
    </div>

    <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzZ5tTF-Rb4wD1XT7_HRnl0S-8-Mv8J9pSXBzz4wx9RHQVTGdJFTs-exOg_3efivwPo/exec"; // REEMPLAZA ESTO
    let datosActuales = [];

    window.onload = () => {
        // Configuración común para ambos calendarios
        const configCalendario = {
            locale: "es",
            dateFormat: "d/m/Y", // Lo que el usuario ve
            altFormat: "Y-m-d",  // Lo que enviamos al servidor
            disableMobile: "true",
            onChange: function() {
                cargarAnalisis(); // Se dispara al seleccionar fecha
            }
        };

        // Inicializar "Desde" (1ero de mes)
        const hoy = new Date();
        const primero = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        
        flatpickr("#fInicio", {
            ...configCalendario,
            defaultDate: primero
        });

        // Inicializar "Hasta" (Hoy)
        flatpickr("#fFin", {
            ...configCalendario,
            defaultDate: hoy
        });

        cargarAnalisis();
    };

    async function cargarAnalisis() {
        const contenedor = document.getElementById('tablaCuerpo');
        contenedor.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#8e8e93;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando datos...</td></tr>';

        const inicioRaw = document.getElementById('fInicio')._flatpickr.selectedDates[0];
        const finRaw = document.getElementById('fFin')._flatpickr.selectedDates[0];

        // Convertimos a formato ISO YYYY-MM-DD para tu función de Apps Script
        const inicio = inicioRaw.toISOString().split('T')[0];
        const fin = finRaw.toISOString().split('T')[0];
        const base = document.getElementById('fBase').value;

        // URL limpia sin trucos de cambio de tipo de input
        const url = `${scriptURL}?accion=getAnalisisTijeras&base=${base}&inicio=${inicio}&fin=${fin}&t=${new Date().getTime()}`;
        
        try {
            const response = await fetch(url);
            datosActuales = await response.json();
            renderizarTabla();
            actualizarWidgets();
        } catch (error) {
            console.error("Error:", error);
            contenedor.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#ff3b30;">Error de conexión. Revisa los permisos del script.</td></tr>';
        }
    }

    function renderizarTabla() {
        const contenedor = document.getElementById('tablaCuerpo');
        contenedor.innerHTML = '';

        if (datosActuales.length === 0) {
            contenedor.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#8e8e93;">Sin registros en este periodo.</td></tr>';
            return;
        }

        datosActuales.forEach(fila => {
            const tr = document.createElement('tr');
            // Formato de fecha en español DD/MM/AA
            const fechaObj = new Date(fila[1]);
            const fechaFormateada = isNaN(fechaObj) ? fila[1] : fechaObj.toLocaleDateString('es-MX', { 
                day: '2-digit', month: 'short', year: '2-digit' 
            }).replace('.', '');

            tr.innerHTML = `
                <td style="font-weight:600;">${fechaFormateada}</td>
                <td style="color:#666;">${fila[2]}</td>
                <td><b style="color:var(--ios-blue)">${fila[3]}</b></td>
                <td>${fila[5]}</td>
                <td style="font-style:italic; font-size:13px; color:#444;">${fila[10] || '---'}</td>
                <td><span class="badge-tijera">${fila[6]}</span></td>
            `;
            contenedor.appendChild(tr);
        });
    }

    function actualizarWidgets() {
        document.getElementById('statTotal').innerText = datosActuales.length;
        if (datosActuales.length === 0) {
            document.getElementById('statEco').innerText = "---";
            document.getElementById('statBase').innerText = "---";
            return;
        }

        const ecos = datosActuales.map(f => f[3]);
        const ecoMas = ecos.sort((a,b) => ecos.filter(v => v===a).length - ecos.filter(v => v===b).length).pop();
        document.getElementById('statEco').innerText = ecoMas;

        const bases = datosActuales.map(f => f[2]);
        const baseMas = bases.sort((a,b) => bases.filter(v => v===a).length - bases.filter(v => v===b).length).pop();
        document.getElementById('statBase').innerText = baseMas;
    }
    </script>
</body>
</html>
