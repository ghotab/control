<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Masivo de SIMS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --primary: #007aff; --bg: #ffffff; --text-main: #1d1d1f; --text-sub: #86868b; --border: #f2f2f7; --green: #34c759; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 400px; }

        .header { margin-bottom: 30px; }
        .header h1 { font-size: 32px; font-weight: 800; margin: 0; letter-spacing: -1.5px; }
        .header p { color: var(--text-sub); font-size: 17px; margin-top: 5px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; margin-left: 5px; letter-spacing: 0.5px; }
        
        /* Visor de Cámara Estilo iPhone */
        #video-container { 
            width: 100%; 
            height: 250px; 
            background: #000; 
            border-radius: 25px; 
            overflow: hidden; 
            position: relative;
            margin-bottom: 20px;
            border: 4px solid var(--border);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Cuadro de enfoque */
        .scanner-laser {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; height: 2px;
            background: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 8px red;
            animation: scanning 2s infinite;
        }
        @keyframes scanning { 0% { top: 20%; } 50% { top: 80%; } 100% { top: 20%; } }

        /* Lista de Escaneados */
        .scanned-list {
            background: #f5f5f7;
            border-radius: 20px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .scan-item {
            background: white;
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
            font-weight: 600;
            border-left: 4px solid var(--green);
        }
        
        .counter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 15px; font-size: 13px; font-weight: 800; }

        .btn-submit {
            width: 100%; background: var(--text-main); color: white; border: none; padding: 18px;
            border-radius: 20px; font-size: 17px; font-weight: 700; cursor: pointer;
        }

        .section-box { background: #f5f5f7; border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-top: 5px; font-size: 15px; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Registro Masivo de SIMs</h1>
        <p>Captura múltiple</p>
    </div>

    <div id="video-container">
        <video id="video"></video>
        <div class="scanner-laser"></div>
    </div>

    
    <div class="form-group">
        <label>Compañía</label>
        <select id="compania" onchange="checkCompania(this.value)" required>
            <option value="Yumovil">Yumovil</option>
            <option value="Telcel">Telcel</option>
            <option value="ATT">ATT</option>
            <option value="Unefon">Unefon</option>
            <option value="Movistar">Movistar</option>
        </select>
    </div>
    
    <div class="grid-2">
        <div class="form-group">
            <label>Fecha de Recepcion</label>
            <input type="date" id="fechaRecibido" required>
        </div>
        <div class="form-group">
            <label>Remitente</label>
            <input type="text" id="remitente" placeholder="Quién envía" required>
        </div>
    </div>
    
    
    <div class="counter-header">
        <span style="font-weight: 800; font-size: 14px;">SIMs Capturadas</span>
        <span id="contador" class="badge">0</span>
    </div>
    
    <div id="listaVisual" class="scanned-list">
        <p id="placeholder-text" style="text-align:center; color: var(--text-sub); font-size: 13px;">Los IMEIs aparecerán aquí...</p>
    </div>

    <button type="button" class="btn-submit" onclick="enviarLote()">Registrar Lote Completo</button>
</div>



<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyT8ORsno-zyC1bIOSqG3nFNi4l_Rp6zL5GBtpO7T18kN33jBEeGKhvBbN-bwLm7xlnaw/exec';
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let imeisCapturados = [];

    document.getElementById('fechaRecibido').valueAsDate = new Date();

    // INICIAR CÁMARA AUTOMÁTICAMENTE
    window.onload = () => {
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                const imei = result.text;
                
                // Evitar duplicados en la misma sesión
                if (!imeisCapturados.includes(imei)) {
                    imeisCapturados.push(imei);
                    actualizarInterfaz(imei);
                    
                    // Feedback visual y táctil
                    if (navigator.vibrate) navigator.vibrate(100);
                }
            }
        });
    };

    function actualizarInterfaz(nuevoImei) {
        const lista = document.getElementById('listaVisual');
        const placeholder = document.getElementById('placeholder-text');
        if (placeholder) placeholder.remove();

        const item = document.createElement('div');
        item.className = 'scan-item';
        item.innerHTML = `<span>${nuevoImei}</span> <i class="fa-solid fa-check-circle" style="color: var(--green);"></i>`;
        lista.prepend(item);

        document.getElementById('contador').innerText = imeisCapturados.length;
    }

    function enviarLote() {
        if (imeisCapturados.length === 0) return alert("❌ No hay nada que registrar.");
        
        const btn = document.querySelector('.btn-submit');
        btn.disabled = true;
        btn.innerText = "Registrando las sims...";

        const datos = {
            accion: "RECEPCION",
            imeis: imeisCapturados,
            compania: document.getElementById('compania').value,
            remitente: document.getElementById('remitente').value,
            fecha: document.getElementById('fechaRecibido').value,
            comentarios: "Carga masiva vía cámara"
        };

        fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(datos)
        })
        .then(() => {
            alert(`✅ ${imeisCapturados.length} SIMS registradas exitosamente.`);
            location.reload();
        })
        .catch(err => {
            alert("Error al conectar con el servidor.");
            btn.disabled = false;
        });
    }
</script>
</body>
</html>
