<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAB | Reporte Jefatura</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --ios-bg: #f2f2f7;
            --ios-sidebar: rgba(246, 246, 246, 0.94);
            --ios-blue: #007aff;
            --ios-green: #34c759;
            --ios-red: #ff3b30;
            --ios-card: #ffffff;
            --ios-border: #d1d1d6;
            --ios-text: #000000;
            --ios-text-sec: #8e8e93;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background-color: var(--ios-bg);
            margin: 0; display: flex; height: 100vh; color: var(--ios-text); overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px; background: var(--ios-sidebar); backdrop-filter: blur(20px);
            border-right: 0.5px solid var(--ios-border); display: flex; flex-direction: column;
            transition: transform 0.3s ease; z-index: 1000;
        }

        .sidebar-content { padding: 40px 20px; flex-grow: 1; }
        .sidebar h1 { font-size: 22px; font-weight: 700; margin-bottom: 25px; letter-spacing: -0.5px; }

        .nav-item {
            display: flex; align-items: center; padding: 10px 12px; border-radius: 8px;
            background: rgba(0, 122, 255, 0.1); color: var(--ios-blue); font-weight: 600;
            font-size: 15px;
        }
        .nav-item i { width: 28px; font-size: 18px; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        
        .top-bar { padding: 20px 40px; display: flex; align-items: center; position: sticky; top: 0; background: var(--ios-bg); z-index: 10; }
        .top-bar h2 { margin: 0; font-size: 28px; letter-spacing: -1px; }

        .form-area { padding: 0 40px 60px; max-width: 600px; width: 100%; }

        /* --- iOS LIST STYLE --- */
        .ios-section-title { font-size: 13px; color: var(--ios-text-sec); text-transform: uppercase; margin: 25px 15px 8px; font-weight: 400; }
        .ios-list { background: var(--ios-card); border-radius: 12px; overflow: hidden; border: 0.5px solid var(--ios-border); }
        
        .ios-item {
            padding: 12px 16px; border-bottom: 0.5px solid var(--ios-border);
            display: flex; align-items: center; min-height: 48px;
        }
        .ios-item:last-child { border-bottom: none; }
        
        .item-label { flex: 1; font-size: 17px; display: flex; align-items: center; gap: 12px; }
        .item-label i { color: var(--ios-blue); width: 22px; text-align: center; }

        /* --- CONTROLES --- */
        input, select, textarea {
            border: none; background: transparent; font-size: 17px; 
            color: var(--ios-text); font-family: inherit; outline: none;
            text-align: right; width: 50%;
        }
        textarea { text-align: left; width: 100%; min-height: 100px; padding: 10px 0; resize: none; }
        input::placeholder { color: #c7c7cc; }

        /* --- APPLE SWITCH --- */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9eb; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--ios-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- BUTTONS --- */
        .btn-container { margin-top: 30px; }
        .btn-blue {
            width: 100%; background: var(--ios-blue); color: white; border: none;
            padding: 16px; border-radius: 12px; font-size: 17px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-blue:active { transform: scale(0.97); opacity: 0.9; }

        /* --- OVERLAYS --- */
        .overlay { position: fixed; inset: 0; background: var(--ios-bg); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--ios-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); height: 100%; }
            .form-area, .top-bar { padding: 20px; }
            #menu-btn { display: block !important; }
        }
        #menu-btn { display: none; background: none; border: none; font-size: 24px; color: var(--ios-blue); margin-right: 15px; }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <h1>TAB Gestión</h1>
            <div class="nav-item"><i class="fa-solid fa-file-signature"></i> Reporte Jefatura</div>
        </div>
    </div>

    <div class="main-content">
        <header class="top-bar">
            <button id="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars-staggered"></i></button>
            <h2>Nueva Falla</h2>
        </header>

        <div class="form-area">
            <div class="ios-section-title">Datos de Operación</div>
            <div class="ios-list">
                <div class="ios-item">
                    <div class="item-label"><i class="fa-solid fa-location-dot"></i> Base</div>
                    <select id="base" onchange="localStorage.setItem('baseJefatura', this.value)">
                        <option value="" disabled selected>Seleccionar</option>
                        <option value="ACAP">Acapulco</option>
                        <option value="ATLA">Atlacomulco</option>
                        <option value="COLI">Colima</option>
                        <option value="GUZM">Ciudad Guzmán</option>
                        <option value="GDLJ">Guadalajara</option>
                        <option value="JILO">Jilotepec</option>
                        <option value="MORE">Morelia</option>
                        <option value="OFOC">Occidente</option>
                        <option value="JRIO">San Juan del Río</option>
                        <option value="TSAT">Saturno</option>
                        <option value="TOLU">Toluca</option>
                    </select>
                </div>
                <div class="ios-item">
                    <div class="item-label"><i class="fa-solid fa-bus"></i> Autobús</div>
                    <input type="text" id="autobus" inputmode="numeric" placeholder="Número">
                </div>
            </div>

            <div class="ios-section-title">Clasificación Técnica</div>
            <div class="ios-list">
                <div class="ios-item">
                    <div class="item-label"><i class="fa-solid fa-tags"></i> Categoría</div>
                    <select id="categoria">
                        <option value="BITACORA">Bitacora Electrónica</option>
                        <option value="BOLETERA">Boletera (OS/Hardware)</option>
                        <option value="APLICACION">Aplicación de TI</option>
                        <option value="CCTV">CCTV a Bordo</option>
                        <option value="DASHCAM">Camara Inteligente</option>
                        <option value="TPV">Terminal Bancaria</option>
                        <option value="SIM">SIM</option>
                        <option value="MODEM">Modem</option>
                        <option value="OTRO">Otro...</option>
                    </select>
                </div>
                <div class="ios-item">
                    <div class="item-label"><i class="fa-solid fa-triangle-exclamation"></i> Prioridad Alta</div>
                    <label class="switch">
                        <input type="checkbox" id="prioridad">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="ios-section-title">Descripción del Problema</div>
            <div class="ios-list">
                <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                    <textarea id="falla" placeholder="Escribe aquí el detalle de la falla detectada..."></textarea>
                </div>
            </div>

            <div class="ios-section-title">Identificación</div>
            <div class="ios-list">
                <div class="ios-item">
                    <div class="item-label"><i class="fa-solid fa-id-badge"></i> PIN Jefatura</div>
                    <input type="password" id="pin" inputmode="numeric" placeholder="••••">
                </div>
            </div>

            <div class="btn-container">
                <button class="btn-blue" onclick="enviar()">Enviar Reporte a Sistema</button>
            </div>
        </div>
    </div>

    <div id="loading" class="overlay">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:500;">Sincronizando Datos...</p>
    </div>

    <div id="success" class="overlay">
        <div style="background: var(--ios-green); color: white; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px;">
            <i class="fa-solid fa-check"></i>
        </div>
        <h2 style="margin: 0;">Reporte Registrado</h2>
        <p style="color: var(--ios-text-sec); margin-top: 8px;">La unidad ha sido añadida a la cola.</p>
        <button class="btn-blue" style="width: auto; padding: 12px 40px; margin-top: 30px; background: #e5e5ea; color: black;" onclick="location.reload()">Nuevo Reporte</button>
    </div>

    <script>
        // Carga inicial de base
        window.onload = () => {
            const b = localStorage.getItem('baseJefatura');
            if(b) document.getElementById('base').value = b;
        };

        async function enviar() {
            const url = "https://script.google.com/macros/s/AKfycbzZ5tTF-Rb4wD1XT7_HRnl0S-8-Mv8J9pSXBzz4wx9RHQVTGdJFTs-exOg_3efivwPo/exec";
            
            const base = document.getElementById('base').value;
            const autobus = document.getElementById('autobus').value;
            const categoria = document.getElementById('categoria').value;
            const falla = document.getElementById('falla').value;
            const pin = document.getElementById('pin').value;
            const esPrioritario = document.getElementById('prioridad').checked;

            if(!base || !autobus || !falla || !pin) {
                alert("⚠️ Todos los campos son obligatorios.");
                return;
            }

            // Objeto de datos ajustado a tu nueva estructura de columnas
            const payload = {
                accion: "NUEVO",
                base: base,
                unidad: autobus,               // Mapea a Autobus
                conductor: pin,        // Mapea a ClaveConductor
                falla: falla,                   // Mapea a Falla
                categoria: categoria,           // NUEVO CAMPO
                prioridad: esPrioritario ? "ALTA" : "NORMAL", // NUEVO CAMPO
                estatus: "PENDIENTE"
            };

            document.getElementById('loading').style.display = 'flex';

            try {
                // Envío no-cors para Google Apps Script
                fetch(url, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify(payload)
                });

                // Feedback visual con delay de seguridad
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('success').style.display = 'flex';
                }, 1500);

            } catch (e) {
                alert("Error de red");
                document.getElementById('loading').style.display = 'none';
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.style.transform = sb.style.transform === 'translateX(0%)' ? 'translateX(-100%)' : 'translateX(0%)';
        }
    </script>
</body>
</html>
