<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAB Panel de Pendientes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --mac-bg: #f5f5f7;
            --mac-card: rgba(255, 255, 255, 0.9);
            --accent: #007aff;
            --text: #1d1d1f;
            --text-sec: #86868b;
            --success: #34c759;
            --warning: #ff9500;
            --border: #e5e5ea;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--mac-bg);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        .container { width: 100%; max-width: 800px; }

        /* Header macOS Style */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 30px; margin-top: 20px;
        }
        .header h1 { font-size: 34px; font-weight: 700; letter-spacing: -1px; margin: 0; }
        #sync-status { font-size: 13px; font-weight: 600; color: var(--success); transition: 0.3s; }

        /* Lista de Tareas */
        .task-list { display: grid; gap: 12px; width: 100%; }

        .task-card {
            background: var(--mac-card);
            border-radius: 20px;
            padding: 22px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.02);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-card:active { transform: scale(0.98); background: #fff; }

        .task-info h2 { margin: 0; font-size: 20px; font-weight: 700; color: var(--text); }
        .task-info p { margin: 4px 0 0; color: var(--text-sec); font-size: 14px; }

        .status-badge {
            padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700;
            background: #f2f2f7; color: var(--accent);
        }

        /* Modal / Detalle de Tarea */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(15px);
            justify-content: center; align-items: center; z-index: 1000; padding: 20px;
            box-sizing: border-box;
        }
        .modal-content {
            background: #fff; width: 100%; max-width: 500px; padding: 30px;
            border-radius: 35px; box-shadow: 0 30px 60px rgba(0,0,0,0.2);
            position: relative; max-height: 90vh; overflow-y: auto;
        }

        /* Elements inside Modal */
        label.section-label { 
            display: block; font-size: 11px; font-weight: 800; color: var(--text-sec); 
            text-transform: uppercase; margin-top: 20px; margin-bottom: 8px;
        }

        /* iPhone Switches */
        .switch-group {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid var(--mac-bg);
        }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e3e3e8; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        input[type="password"], textarea {
            width: 100%; border: 1px solid var(--border); border-radius: 14px;
            padding: 15px; font-size: 16px; margin-top: 5px; box-sizing: border-box;
            background: #f9f9fb; font-family: inherit;
        }

        .btn-action {
            width: 100%; background: var(--accent); color: white; border: none;
            padding: 20px; border-radius: 18px; font-size: 18px; font-weight: 700; 
            margin-top: 25px; cursor: pointer; transition: 0.2s;
        }
        .btn-action:active { transform: scale(0.97); }

        .qr-section { text-align: center; display: none; margin-top: 25px; }
        #qrcode-container { 
            margin: 20px auto; width: 180px; height: 180px; background: #fff;
            border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;
        }

        /* Estilo para reporte original en modal */
        .report-summary {
            background: #f2f2f7; padding: 15px; border-radius: 15px; margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Reportes de Operador Pendientes</h1>
        <div id="sync-status"><i class="fa-solid fa-rotate"></i> Actualizado</div>
    </div>

    <div id="taskList" class="task-list">
        <p style="text-align: center; color: var(--text-sec);">Cargando reporte de fallas...</p>
    </div>
</div>

<div id="modalTarea" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="margin: 0; font-size: 28px;">Unidad</h2>
        <p id="modalBase" style="color: var(--text-sec); margin-top: 5px; font-weight: 600;">Base</p>
        
        <hr style="border: 0; border-top: 1px solid var(--mac-bg); margin: 20px 0;">

        <div id="step1">
            <label class="section-label">Acceso Técnico</label>
            <input type="password" id="claveTecnico" placeholder="Introduce tu clave de colaborador" inputmode="numeric">
            <button class="btn-action" onclick="validarTecnico()">Ver Reporte de Conductor</button>
        </div>

        <div id="step2" style="display:none;">
            <div class="report-summary">
                <label class="section-label" style="margin-top: 0;">Falla Reportada</label>
                <div id="fallaTexto" style="font-size: 18px; font-weight: 600;">...</div>
            </div>
            
            <div class="switch-group">
                <span style="font-weight: 600;">¿Corte de boletos de tijera?</span>
                <label class="switch">
                    <input type="checkbox" id="switchTijera">
                    <span class="slider"></span>
                </label>
            </div>

            <label class="section-label">Causa de la Falla</label>
            <textarea id="causaFalla" rows="2" placeholder="¿Qué originó el problema?"></textarea>

            <label class="section-label">Correctivo Realizado</label>
            <textarea id="correctivo" rows="2" placeholder="¿Qué solución aplicaste?"></textarea>

            <div class="switch-group">
                <span style="font-weight: 600;">Requiere firma de conductor</span>
                <label class="switch">
                    <input type="checkbox" id="switchFirma" checked onchange="actualizarTextoBoton()">
                    <span class="slider"></span>
                </label>
            </div>

            <button id="btnPrincipal" class="btn-action" onclick="procesarAtencion()">Confirmar y Generar QR</button>
        </div>

        <div id="qrSection" class="qr-section">
            <h3 style="margin-bottom: 5px;">Validación de Operador</h3>
            <p style="font-size: 14px; color: var(--text-sec);">Solicita al conductor que escanee este código para firmar la recepción.</p>
            <div id="qrcode-container">
                <i class="fa-solid fa-qrcode" style="font-size: 120px; color: #333;"></i>
            </div>
            <div style="background: #fff3e0; padding: 10px; border-radius: 10px; color: var(--warning); font-size: 13px; font-weight: 600;">
                <i class="fa-solid fa-hourglass-half"></i> Esperando firma digital...
            </div>
        </div>
    </div>
</div>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzZ5tTF-Rb4wD1XT7_HRnl0S-8-Mv8J9pSXBzz4wx9RHQVTGdJFTs-exOg_3efivwPo/exec"; 
    let idActual = "";
    
    // 1. CARGA AUTOMÁTICA
    async function cargarPendientes() {
        try {
            const res = await fetch(`${scriptURL}?accion=leerPendientes`);
            const tareas = await res.json();
            const lista = document.getElementById('taskList');
            lista.innerHTML = "";
    
            if (tareas.length === 0) {
                lista.innerHTML = "<p style='text-align:center; color:gray; padding:20px;'>No hay fallas pendientes.</p>";
                return;
            }
    
            tareas.forEach(t => {
                lista.innerHTML += `
                    <div class="task-card" onclick="abrirTarea('${t[0]}', '${t[3]}', '${t[2]}')">
                        <div class="task-info">
                            <h2>Unidad ${t[3]}</h2>
                            <p>Base: ${t[2]} • ID: ${t[0]}</p>
                        </div>
                        <div class="status-badge">${t[6]}</div>
                    </div>`;
            });
            document.getElementById('sync-status').innerHTML = '<i class="fa-solid fa-check-circle"></i> Sincronizado';
        } catch (e) {
            document.getElementById('sync-status').innerHTML = '<span style="color:red;">Error de red</span>';
        }
    }
    
    // 2. CAMBIO DE TEXTO DEL BOTÓN DINÁMICO
    function actualizarTextoBoton() {
        const requiereFirma = document.getElementById('switchFirma').checked;
        const btn = document.getElementById('btnPrincipal');
        btn.innerText = requiereFirma ? "Confirmar y Generar QR" : "Guardar Reporte";
    }
    
    // 3. ABRIR TAREA
    function abrirTarea(id, eco, base) {
        idActual = id;
        document.getElementById('modalTarea').style.display = 'flex';
        document.getElementById('modalTitle').innerText = "Unidad " + eco;
        document.getElementById('modalBase').innerText = "Base: " + base;
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('qrSection').style.display = 'none';
        document.getElementById('claveTecnico').value = "";
        actualizarTextoBoton(); // Resetear texto del botón
    }
    
    // 4. VALIDAR TÉCNICO (ENTRAR AL DETALLE)
    async function validarTecnico() {
        const clave = document.getElementById('claveTecnico').value;
        if(!clave) return alert("Ingresa tu clave de colaborador.");
    
        const btn = document.querySelector('#step1 .btn-action');
        btn.innerText = "Cargando...";
    
        try {
            const res = await fetch(`${scriptURL}?accion=detalle&id=${idActual}`);
            const data = await res.json();
            
            document.getElementById('fallaTexto').innerText = data.falla;
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        } catch (e) {
            alert("No se pudo obtener el detalle de la falla.");
        } finally {
            btn.innerText = "Ver Reporte de Conductor";
        }
    }
    
    // 5. PROCESAR ATENCIÓN (EL PASO CRÍTICO)
    async function procesarAtencion() {
        const tecnico = document.getElementById('claveTecnico').value;
        const causa = document.getElementById('causaFalla').value;
        const solucion = document.getElementById('correctivo').value; // Asegúrate que el ID sea 'correctivo'
        const tijera = document.getElementById('switchTijera').checked ? "SÍ" : "NO";
        const requiereFirma = document.getElementById('switchFirma').checked;
    
        if(!causa || !solucion) {
            alert("Debes llenar la Causa y el Correctivo.");
            return;
        }
    
        const btn = document.getElementById('btnPrincipal');
        btn.innerText = "Guardando en Excel...";
        btn.disabled = true;
    
        // Estos nombres deben coincidir con tu GS (datos.id, datos.tecnico, etc.)
        const datos = {
            accion: "VALIDAR_TECNICO",
            id: idActual,
            tecnico: tecnico,
            tijera: tijera,
            causa: causa,
            solucion: solucion,
            requiereFirma: requiereFirma
        };
    
        try {
            // Enviar al GS
            await fetch(scriptURL, { 
                method: "POST", 
                mode: "no-cors", 
                body: JSON.stringify(datos) 
            });
            
            // Como usamos no-cors, esperamos 1.5 segundos para dar tiempo al GS de procesar
            setTimeout(() => {
                if (requiereFirma) {
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('qrSection').style.display = 'block';
                } else {
                    alert("✅ Reporte finalizado con éxito.");
                    location.reload(); // Recargar para limpiar y ver cambios
                }
            }, 1500);
    
        } catch (e) {
            alert("Error al enviar. Intenta de nuevo.");
            btn.disabled = false;
            btn.innerText = "Reintentar Guardar";
        }
    }
    
    // Inicialización
    cargarPendientes();
    setInterval(cargarPendientes, 30000);
    
    // Cerrar al tocar fuera
    window.onclick = e => { if(e.target == document.getElementById('modalTarea')) document.getElementById('modalTarea').style.display="none"; }
</script>

</body>
</html>
